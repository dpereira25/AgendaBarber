{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Agenda de {{ barbero.nombre }}
                    </h3>
                    <small class="text-light">
                        <i class="fas fa-info-circle me-1"></i>
                        Mostrando solo reservas confirmadas y pagadas
                    </small>
                </div>
                <div class="card-body">

                    {% if reservas %}
                    <!-- Filtros rápidos -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="btn-group w-100" role="group" aria-label="Filtros de reservas">
                                <button type="button" class="btn btn-outline-primary active"
                                    onclick="filtrarReservas('todas')">
                                    <i class="fas fa-list me-1 d-none d-md-inline"></i>Todas
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="filtrarReservas('hoy')">
                                    <i class="fas fa-calendar-day me-1 d-none d-md-inline"></i>Hoy
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="filtrarReservas('semana')">
                                    <i class="fas fa-calendar-week me-1 d-none d-md-inline"></i>Esta Semana
                                </button>
                                <button type="button" class="btn btn-outline-warning"
                                    onclick="filtrarReservas('pendientes')">
                                    <i class="fas fa-clock me-1 d-none d-md-inline"></i>Pendientes
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text d-md-none">
                                    <i class="fas fa-calendar"></i>
                                </span>
                                <input type="date" class="form-control" id="filtroFecha" onchange="filtrarPorFecha()" 
                                       placeholder="Filtrar por fecha">
                                <button class="btn btn-outline-secondary" onclick="limpiarFiltros()" 
                                        title="Limpiar filtros">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de reservas -->
                    <div class="row" id="listaReservas">
                        {% for reserva in reservas %}
                        <div class="col-12 mb-3 reserva-item" data-fecha="{{ reserva.inicio|date:'Y-m-d' }}"
                            data-estado="{{ reserva.estado }}" data-hoy="{% now 'Y-m-d' %}">
                            <div class="card {% if reserva.inicio|date:'Y-m-d' == today %}border-primary{% endif %}">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-2">
                                            <div class="text-center">
                                                <div class="h4 mb-0 text-primary">{{ reserva.inicio|date:"d" }}</div>
                                                <div class="small text-muted">{{ reserva.inicio|date:"M Y" }}</div>
                                                <div class="small">{{ reserva.inicio|date:"l" }}</div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-center">
                                                <div class="h5 mb-0">{{ reserva.inicio|date:"H:i" }}</div>
                                                <div class="small text-muted">{{ reserva.fin|date:"H:i" }}</div>
                                                <span class="badge bg-secondary">{{ reserva.servicio.duracion_minutos }}min</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div>
                                                <i class="fas fa-user text-primary me-2"></i>
                                                <strong>{{ reserva.cliente.get_full_name|default:reserva.cliente.username }}</strong>
                                            </div>
                                            <div class="small text-muted">
                                                <i class="fas fa-envelope me-1"></i>{{ reserva.cliente.email }}
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div>
                                                <i class="fas fa-scissors text-success me-2"></i>
                                                <strong>{{ reserva.servicio.nombre }}</strong>
                                            </div>
                                            <div class="small text-muted">
                                                <i class="fas fa-dollar-sign me-1"></i>${{ reserva.servicio.precio|floatformat:0 }}
                                            </div>
                                            <div class="small">
                                                <i class="fas fa-credit-card me-1 text-primary"></i>
                                                <strong>{{ reserva.payment_method|default:"MercadoPago" }}</strong>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-center">
                                                <span
                                                    class="badge {% if reserva.estado == 'Confirmada' %}bg-success{% elif reserva.estado == 'Pendiente' %}bg-warning{% elif reserva.estado == 'Cancelada' %}bg-danger{% else %}bg-info{% endif %} mb-2">
                                                    {{ reserva.estado }}
                                                </span>
                                                <br>
                                                {% if reserva.pagado %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>Pagado
                                                </span>
                                                <br>
                                                <small class="text-muted">
                                                    <i class="fas fa-credit-card me-1"></i>{{ reserva.payment_method|default:"MercadoPago" }}
                                                </small>
                                                {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-clock me-1"></i>Pendiente
                                                </span>
                                                {% endif %}

                                                <!-- Acciones rápidas -->
                                                <div class="mt-2">
                                                    <button class="btn btn-outline-info btn-sm" 
                                                            onclick="showPaymentDetails('{{ reserva.id }}')" 
                                                            title="Ver detalles del pago">
                                                        <i class="fas fa-info-circle"></i>
                                                    </button>
                                                    {% if reserva.estado == 'Pendiente' %}
                                                        <button class="btn btn-success btn-sm" onclick="confirmarReserva('{{ reserva.id }}')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-danger btn-sm" onclick="cancelarReserva('{{ reserva.id }}')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    {% elif reserva.estado == 'Confirmada' and reserva.inicio|date:'Y-m-d' <= today %}
                                                        <button class="btn btn-info btn-sm" onclick="completarReserva('{{ reserva.id }}')">
                                                            <i class="fas fa-check-double"></i>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Estadísticas del barbero -->
                <div class="row mt-4">
                    <div class="col-md-2 col-6 mb-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h4>{{ reservas|length }}</h4>
                                <small>Total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h4 id="countPendientes">0</h4>
                                <small>Pendientes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h4 id="countConfirmadas">0</h4>
                                <small>Confirmadas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h4 id="countHoy">0</h4>
                                <small>Hoy</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <div class="card bg-secondary text-white">
                            <div class="card-body text-center">
                                <h4 id="countSemana">0</h4>
                                <small>Esta Semana</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <div class="card bg-dark text-white">
                            <div class="card-body text-center">
                                <h4 id="ingresosMes">$0</h4>
                                <small>Este Mes</small>
                            </div>
                        </div>
                    </div>
                </div>

                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No tienes reservas aún</h4>
                    <p class="text-muted">Las reservas de tus clientes aparecerán aquí.</p>
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</div>

<!-- Payment Details Modal -->
<div class="modal fade" id="paymentDetailsModal" tabindex="-1" aria-labelledby="paymentDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="paymentDetailsModalLabel">
                    <i class="fas fa-credit-card me-2"></i>Detalles del Pago
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="paymentDetailsContent">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p class="mt-2">Cargando detalles del pago...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
</div>

<script>
    // Funciones para filtrar reservas
    function filtrarReservas(tipo) {
        const reservas = document.querySelectorAll('.reserva-item');
        const hoy = new Date().toISOString().split('T')[0];

        // Actualizar botones activos
        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        reservas.forEach(reserva => {
            const fecha = reserva.dataset.fecha;
            const estado = reserva.dataset.estado;
            let mostrar = false;

            switch (tipo) {
                case 'todas':
                    mostrar = true;
                    break;
                case 'hoy':
                    mostrar = fecha === hoy;
                    break;
                case 'semana':
                    const fechaReserva = new Date(fecha);
                    const inicioSemana = new Date();
                    inicioSemana.setDate(inicioSemana.getDate() - inicioSemana.getDay());
                    const finSemana = new Date(inicioSemana);
                    finSemana.setDate(inicioSemana.getDate() + 6);
                    mostrar = fechaReserva >= inicioSemana && fechaReserva <= finSemana;
                    break;
                case 'pendientes':
                    mostrar = estado === 'Pendiente';
                    break;
            }

            reserva.style.display = mostrar ? 'block' : 'none';
        });
    }

    function filtrarPorFecha() {
        const fechaSeleccionada = document.getElementById('filtroFecha').value;
        const reservas = document.querySelectorAll('.reserva-item');

        reservas.forEach(reserva => {
            const fecha = reserva.dataset.fecha;
            reserva.style.display = fecha === fechaSeleccionada ? 'block' : 'none';
        });
    }

    function limpiarFiltros() {
        document.getElementById('filtroFecha').value = '';
        filtrarReservas('todas');
    }

    // Funciones de acción
    function confirmarReserva(reservaId) {
        if (confirm('¿Confirmar esta reserva?')) {
            // Implementar lógica AJAX
            alert('Funcionalidad pendiente de implementar');
        }
    }

    function cancelarReserva(reservaId) {
        if (confirm('¿Estás seguro de cancelar esta reserva?\n\nEl cliente será notificado de la cancelación.')) {
            // Mostrar indicador de carga
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            // Realizar petición AJAX
            fetch('/cancelar-reserva/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    'reserva_id': reservaId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar mensaje de éxito
                    showAlert('success', data.message);
                    
                    // Recargar la página después de un breve delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    // Mostrar mensaje de error
                    showAlert('error', data.message);
                    
                    // Restaurar botón
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('error', 'Error de conexión. Inténtalo de nuevo.');
                
                // Restaurar botón
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }
    }

    function completarReserva(reservaId) {
        if (confirm('¿Marcar como completada?')) {
            // Implementar lógica AJAX
            alert('Funcionalidad pendiente de implementar');
        }
    }

    function showPaymentDetails(reservaId) {
        const modal = new bootstrap.Modal(document.getElementById('paymentDetailsModal'));
        const content = document.getElementById('paymentDetailsContent');
        
        // Show loading state
        content.innerHTML = `
            <div class="text-center">
                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                <p class="mt-2">Cargando detalles del pago...</p>
            </div>
        `;
        
        modal.show();
        
        // Fetch payment details
        fetch(`/api/reserva/${reservaId}/payment-details/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                content.innerHTML = generatePaymentDetailsHTML(data.payment_details, data.reserva);
            } else {
                content.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.message || 'No se pudieron cargar los detalles del pago'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching payment details:', error);
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error al cargar los detalles del pago. Inténtalo de nuevo.
                </div>
            `;
        });
    }

    function generatePaymentDetailsHTML(paymentDetails, reserva) {
        const paymentStatusBadge = paymentDetails.status === 'approved' ? 
            '<span class="badge bg-success">Aprobado</span>' :
            paymentDetails.status === 'pending' ? 
            '<span class="badge bg-warning">Pendiente</span>' :
            '<span class="badge bg-danger">Rechazado</span>';

        return `
            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-primary">
                                <i class="fas fa-info-circle me-1"></i>Información de la Reserva
                            </h6>
                            <hr>
                            <p class="mb-2">
                                <strong><i class="fas fa-user me-2 text-primary"></i>Cliente:</strong>
                                ${reserva.cliente_nombre}
                            </p>
                            <p class="mb-2">
                                <strong><i class="fas fa-envelope me-2 text-info"></i>Email:</strong>
                                ${reserva.cliente_email}
                            </p>
                            <p class="mb-2">
                                <strong><i class="fas fa-scissors me-2 text-success"></i>Servicio:</strong>
                                ${reserva.servicio_nombre}
                            </p>
                            <p class="mb-2">
                                <strong><i class="fas fa-calendar me-2 text-warning"></i>Fecha:</strong>
                                ${reserva.fecha_formateada}
                            </p>
                            <p class="mb-0">
                                <strong><i class="fas fa-clock me-2 text-secondary"></i>Hora:</strong>
                                ${reserva.hora_inicio} - ${reserva.hora_fin}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-success">
                                <i class="fas fa-credit-card me-1"></i>Detalles del Pago
                            </h6>
                            <hr>
                            <p class="mb-2">
                                <strong><i class="fas fa-dollar-sign me-2 text-success"></i>Monto:</strong>
                                $${paymentDetails.amount}
                            </p>
                            <p class="mb-2">
                                <strong><i class="fas fa-credit-card me-2 text-primary"></i>Método:</strong>
                                ${paymentDetails.payment_method || 'MercadoPago'}
                            </p>
                            <p class="mb-2">
                                <strong><i class="fas fa-check-circle me-2 text-info"></i>Estado:</strong>
                                ${paymentStatusBadge}
                            </p>
                            ${paymentDetails.mp_payment_id ? `
                            <p class="mb-2">
                                <strong><i class="fas fa-receipt me-2 text-warning"></i>ID MercadoPago:</strong>
                                <code>${paymentDetails.mp_payment_id}</code>
                            </p>
                            ` : ''}
                            <p class="mb-2">
                                <strong><i class="fas fa-calendar-plus me-2 text-secondary"></i>Fecha Pago:</strong>
                                ${paymentDetails.created_at}
                            </p>
                            ${paymentDetails.updated_at !== paymentDetails.created_at ? `
                            <p class="mb-0">
                                <strong><i class="fas fa-sync me-2 text-info"></i>Última Actualización:</strong>
                                ${paymentDetails.updated_at}
                            </p>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
            
            ${paymentDetails.status === 'approved' ? `
            <div class="alert alert-success mt-3">
                <h6><i class="fas fa-check-circle me-2"></i>Pago Confirmado</h6>
                <p class="mb-0">El pago ha sido procesado exitosamente. La reserva está confirmada y pagada.</p>
            </div>
            ` : paymentDetails.status === 'pending' ? `
            <div class="alert alert-warning mt-3">
                <h6><i class="fas fa-hourglass-half me-2"></i>Pago Pendiente</h6>
                <p class="mb-0">El pago está siendo procesado. La reserva se confirmará automáticamente una vez que se complete.</p>
            </div>
            ` : `
            <div class="alert alert-danger mt-3">
                <h6><i class="fas fa-times-circle me-2"></i>Pago Rechazado</h6>
                <p class="mb-0">El pago no pudo ser procesado. La reserva no está confirmada.</p>
            </div>
            `}
        `;
    }

    // Función para obtener el token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Función para mostrar alertas
    function showAlert(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
        
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="fas ${iconClass} me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Insertar al inicio del contenedor principal
        const container = document.querySelector('.container');
        container.insertAdjacentHTML('afterbegin', alertHtml);
    }

    // Calcular estadísticas al cargar
    document.addEventListener('DOMContentLoaded', function () {
        calcularEstadisticas();
    });

    function calcularEstadisticas() {
        const reservas = document.querySelectorAll('.reserva-item');
        const hoy = new Date().toISOString().split('T')[0];

        let pendientes = 0, confirmadas = 0, reservasHoy = 0, reservasSemana = 0;

        reservas.forEach(reserva => {
            const fecha = reserva.dataset.fecha;
            const estado = reserva.dataset.estado;

            if (estado === 'Pendiente') pendientes++;
            if (estado === 'Confirmada') confirmadas++;
            if (fecha === hoy) reservasHoy++;

            // Calcular semana
            const fechaReserva = new Date(fecha);
            const inicioSemana = new Date();
            inicioSemana.setDate(inicioSemana.getDate() - inicioSemana.getDay());
            const finSemana = new Date(inicioSemana);
            finSemana.setDate(inicioSemana.getDate() + 6);
            if (fechaReserva >= inicioSemana && fechaReserva <= finSemana) {
                reservasSemana++;
            }
        });

        document.getElementById('countPendientes').textContent = pendientes;
        document.getElementById('countConfirmadas').textContent = confirmadas;
        document.getElementById('countHoy').textContent = reservasHoy;
        document.getElementById('countSemana').textContent = reservasSemana;
    }
</script>

{% endblock %}